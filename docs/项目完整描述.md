# Grape MCP DevTools - 多语言文档服务完整描述

## 项目概述

**grape-mcp-devtools** 是一个基于 Model Context Protocol (MCP) 的智能多语言文档服务系统，采用 Rust 语言开发。该项目旨在为 AI 助手提供高效、准确的编程库文档检索和分析能力，通过先进的向量化技术和智能缓存策略，实现对多种编程语言文档的统一管理和快速检索。

### 核心特性

- 🚀 **多语言支持**：支持 Go、Rust、Python、JavaScript/TypeScript、Java、Dart/Flutter 等主流编程语言
- 🔍 **智能文档检索**：基于向量化的语义搜索，提供精确的文档匹配
- 📚 **实时文档生成**：动态生成和缓存各语言的标准文档
- 🏗️ **模块化架构**：清晰的模块分离，易于扩展和维护
- ⚡ **高性能缓存**：多层缓存策略，确保快速响应
- 🔧 **MCP 协议兼容**：完全兼容 Model Context Protocol 标准

## 技术架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    MCP Client (AI Assistant)                │
└─────────────────────┬───────────────────────────────────────┘
                      │ MCP Protocol
┌─────────────────────▼───────────────────────────────────────┐
│                  HTTP Server Layer                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │
│  │   CORS      │ │  Routing    │ │    Error Handling       │ │
│  │ Middleware  │ │  Handler    │ │      Middleware         │ │
│  └─────────────┘ └─────────────┘ └─────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                   MCP Server Core                           │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Tool Registry                              │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────────┐ │ │
│  │  │ Search  │ │Version  │ │Analysis │ │   API Docs      │ │ │
│  │  │  Tool   │ │  Tool   │ │  Tool   │ │     Tool        │ │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                 Vectorization Layer                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │
│  │  Embedding  │ │   Chunking  │ │      File Processing    │ │
│  │   Service   │ │   Strategy  │ │        Pipeline         │ │
│  └─────────────┘ └─────────────┘ └─────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                  Storage Layer                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │
│  │   Qdrant    │ │   Memory    │ │     File System         │ │
│  │  Vector DB  │ │   Cache     │ │       Cache             │ │
│  └─────────────┘ └─────────────┘ └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 核心模块详解

#### 1. MCP 服务器核心 (`src/mcp/`)

**功能**：实现 Model Context Protocol 标准，提供与 AI 助手的通信接口

**主要组件**：
- `server.rs`：MCP 服务器主体，处理协议握手和请求路由
- `protocol.rs`：MCP 协议定义和消息格式
- `mod.rs`：模块统一导出和配置

**MCP 协议支持详情**：

##### 协议版本和能力
```rust
// 支持的 MCP 协议版本
pub const MCP_VERSION: &str = "2025-03-26";

// 服务器支持的核心能力
pub const SERVER_CAPABILITIES: &[&str] = &[
    "documentSearch",      // 文档搜索
    "apiExamples",        // API 示例
    "versionInfo",        // 版本信息
    "compatibilityCheck", // 兼容性检查
];
```

##### 协议消息格式
```rust
// MCP 请求格式
pub struct Request {
    pub version: String,    // 协议版本号
    pub id: String,        // 请求 ID
    pub method: String,    // 请求方法
    pub params: Value,     // 请求参数
}

// MCP 响应格式
pub struct Response {
    pub version: String,           // 协议版本号
    pub id: String,               // 请求 ID
    pub result: Option<Value>,    // 响应结果
    pub error: Option<ErrorResponse>, // 错误信息
}
```

##### 支持的 MCP 方法

| 方法名 | 功能描述 | 参数 | 返回值 |
|--------|----------|------|--------|
| `initialize` | 初始化连接 | `InitializeParams` | `InitializeResult` |
| `shutdown` | 关闭连接 | 无 | `null` |
| `documentSearch` | 文档搜索 | `{query, language?, limit?}` | 搜索结果列表 |
| `getApiExamples` | 获取API示例 | `{package, version?, language?}` | API示例列表 |
| `checkVersionCompatibility` | 版本兼容性检查 | `{package, version, target_version}` | 兼容性报告 |

##### 错误代码定义
```rust
pub mod error_codes {
    // JSON-RPC 标准错误码
    pub const PARSE_ERROR: i32 = -32700;
    pub const INVALID_REQUEST: i32 = -32600;
    pub const METHOD_NOT_FOUND: i32 = -32601;
    pub const INVALID_PARAMS: i32 = -32602;
    pub const INTERNAL_ERROR: i32 = -32603;
    
    // MCP 特定错误码
    pub const DOC_NOT_FOUND: i32 = -33000;
    pub const VERSION_NOT_FOUND: i32 = -33001;
    pub const INCOMPATIBLE_VERSION: i32 = -33002;
    pub const SEARCH_FAILED: i32 = -33003;
    pub const VECTORIZATION_FAILED: i32 = -33004;
}
```

**关键特性**：
- 支持 MCP 协议的完整生命周期管理
- 异步请求处理，支持高并发
- 工具动态注册和管理
- 错误处理和状态管理
- 标准化的错误代码和消息格式

#### 2. 工具系统 (`src/tools/`)

**功能**：提供各种文档处理和分析工具

**工具列表**：

| 工具名称 | 文件 | 功能描述 |
|---------|------|----------|
| **文档搜索工具** | `search.rs` | 基于向量化的语义文档搜索 |
| **版本检查工具** | `versioning.rs` | 检查包版本兼容性和更新 |
| **依赖分析工具** | `dependencies.rs` | 分析项目依赖关系 |
| **代码分析工具** | `analysis.rs` | 代码质量分析和重构建议 |
| **API文档工具** | `api_docs.rs` | 获取和解析API文档 |
| **变更日志工具** | `changelog.rs` | 获取和比较版本变更 |
| **Go文档工具** | `file_go_docs_tool.rs` | 专门处理Go语言文档 |

**工具基础架构**：
- `base.rs`：定义工具接口和注解系统
- 统一的参数验证和错误处理
- 支持工具链式调用和组合

**动态工具注册系统**：

##### 工具注册策略
```rust
pub enum RegistrationStrategy {
    OnlyAvailable,              // 仅注册检测到的可用工具
    ForceAll,                   // 强制注册所有工具
    FeatureBased(Vec<String>),  // 基于特性选择性注册
}
```

##### 已注册的 MCP 工具

**核心工具（始终可用）**：
- `search_docs` - 文档语义搜索工具
- `check_version` - 版本兼容性检查工具
- `analyze_dependencies` - 依赖关系分析工具
- `analyze_code` - 代码质量分析工具
- `get_changelog` - 获取变更日志工具
- `compare_versions` - 版本比较工具
- `get_api_docs` - API文档获取工具

**语言特定工具（基于环境检测）**：

| CLI工具 | 对应MCP工具 | 功能描述 | 检测条件 |
|---------|-------------|----------|----------|
| `cargo` | `rust_version_tool` | Rust包版本管理 | 检测到cargo命令 |
| `npm` | `js_version_tool` | Node.js包版本管理 | 检测到npm命令 |
| `pip` | `python_version_tool` | Python包版本管理 | 检测到pip命令 |
| `mvn` | `java_version_tool` | Maven项目管理 | 检测到mvn命令 |
| `gradle` | `gradle_version_tool` | Gradle项目管理 | 检测到gradle命令 |
| `rustdoc` | `rust_docs_tool` | Rust文档生成 | 检测到rustdoc命令 |
| `jsdoc` | `js_docs_tool` | JavaScript文档生成 | 检测到jsdoc命令 |
| `sphinx-build` | `python_docs_tool` | Python文档生成 | 检测到sphinx-build命令 |
| `clippy` | `rust_lint_tool` | Rust代码检查 | 检测到clippy命令 |
| `eslint` | `js_lint_tool` | JavaScript代码检查 | 检测到eslint命令 |
| `pylint` | `python_lint_tool` | Python代码检查 | 检测到pylint命令 |

**工具接口定义**：
```rust
#[async_trait]
pub trait MCPTool: Send + Sync {
    fn name(&self) -> &str;                    // 工具名称
    fn description(&self) -> &str;             // 工具描述
    fn parameters_schema(&self) -> &Schema;    // 参数Schema
    async fn execute(&self, params: Value) -> Result<Value>; // 执行工具
    fn validate_params(&self, params: &Value) -> Result<()>; // 参数验证
}
```

**工具注册流程**：
1. **环境检测** - 扫描系统中可用的CLI工具
2. **策略应用** - 根据注册策略决定注册哪些工具
3. **工具创建** - 使用工厂模式创建MCP工具实例
4. **注册执行** - 将工具注册到MCP服务器
5. **报告生成** - 生成注册成功/失败的详细报告

#### 3. 向量化系统 (`src/vectorization/`)

**功能**：将文档内容转换为向量表示，支持语义搜索

**核心特性**：
- **多种向量化策略**：
  - 云端API（OpenAI、NVIDIA、智谱AI等）
  - 本地模型（支持ONNX格式）
  - 混合模式（云端+本地备份）
- **智能分块策略**：
  - 文件级向量化（保持完整性）
  - 大文件智能分块
  - 重叠窗口处理
- **缓存优化**：
  - 向量结果缓存
  - 批量处理优化
  - 异步处理管道

#### 4. 存储系统 (`src/storage/`)

**功能**：管理向量数据和元数据的持久化存储

**存储架构**：
- **Qdrant 向量数据库**：
  - 内嵌模式（开发环境）
  - 客户端模式（生产环境）
  - 集合自动管理
  - 索引优化
- **多层缓存系统**：
  - L1：内存缓存（Moka）
  - L2：向量数据库
  - L3：文件系统缓存

#### 5. 错误处理系统 (`src/errors.rs`)

**功能**：统一的错误处理和类型定义

**错误类型**：
```rust
pub enum MCPError {
    // 网络相关错误
    NetworkError(String),
    // 解析错误
    ParseError(String),
    // 向量化错误
    VectorizationError(String),
    // 存储错误
    StorageError(String),
    // 工具执行错误
    ToolExecutionError(String),
    // 配置错误
    ConfigError(String),
}
```

## 配置系统

### 环境变量配置

项目通过 `.env` 文件进行配置，支持以下主要配置项：

#### 向量化配置
```bash
# 向量化器类型
VECTORIZER_TYPE=hybrid  # hybrid/cloud/local

# NVIDIA API 配置（推荐）
EMBEDDING_API_KEY=nvapi-your-key-here
EMBEDDING_API_BASE_URL=https://integrate.api.nvidia.com/v1
EMBEDDING_MODEL_NAME=nvidia/nv-embedcode-7b-v1
EMBEDDING_DIMENSIONS=768
```

#### Qdrant 配置
```bash
# 运行模式
QDRANT_MODE=embedded  # embedded/client

# 内嵌模式配置
QDRANT_STORAGE_PATH=./data/qdrant
QDRANT_ENABLE_WEB=true
QDRANT_WEB_PORT=6333

# 向量数据库配置
VECTOR_DB_COLLECTION_PREFIX=mcp_
VECTOR_DB_DISTANCE=Cosine
VECTOR_DIMENSION=768
```

#### 文件处理配置
```bash
# 文件大小限制
MAX_FILE_SIZE=1048576
CHUNK_SIZE=8192
CHUNK_OVERLAP=512
MAX_CONCURRENT_FILES=10
```

#### 缓存配置
```bash
CACHE_TTL_SECS=86400
CACHE_MAX_SIZE_MB=500
```

## MCP 服务器使用指南

### 启动服务器

项目提供了多个可执行文件，推荐使用动态MCP服务器：

```bash
# 动态检测环境并启动服务器（推荐）
cargo run --bin dynamic_mcp_server

# 仅检测环境，不启动服务器
cargo run --bin dynamic_mcp_server detect --verbose

# 强制注册所有工具
cargo run --bin dynamic_mcp_server --all

# 基于特性选择工具
cargo run --bin dynamic_mcp_server --feature rust --feature javascript

# 启动服务器在指定端口
cargo run --bin dynamic_mcp_server serve --port 8080 --host 0.0.0.0
```

### MCP 客户端连接

服务器启动后，AI助手可以通过以下方式连接：

#### 1. 标准输入/输出模式（推荐）
```bash
# AI助手通过stdin/stdout与MCP服务器通信
echo '{"version":"2025-03-26","id":"1","method":"initialize","params":{"client_name":"AI Assistant","client_version":"1.0"}}' | cargo run --bin dynamic_mcp_server
```

#### 2. HTTP模式（开发中）
```bash
# HTTP API接口（未来版本支持）
curl -X POST http://localhost:8080/mcp \
  -H "Content-Type: application/json" \
  -d '{"version":"2025-03-26","id":"1","method":"documentSearch","params":{"query":"rust async"}}'
```

### 工具调用示例

#### 文档搜索
```json
{
  "version": "2025-03-26",
  "id": "search-1",
  "method": "documentSearch",
  "params": {
    "query": "async await rust tokio",
    "language": "rust",
    "limit": 10
  }
}
```

#### 版本兼容性检查
```json
{
  "version": "2025-03-26",
  "id": "version-1", 
  "method": "checkVersionCompatibility",
  "params": {
    "package": "tokio",
    "version": "1.0.0",
    "target_version": "1.35.0"
  }
}
```

#### API示例获取
```json
{
  "version": "2025-03-26",
  "id": "api-1",
  "method": "getApiExamples", 
  "params": {
    "package": "serde",
    "version": "1.0",
    "language": "rust"
  }
}
```

## 部署架构

### 开发环境部署

```bash
# 1. 克隆项目
git clone <repository-url>
cd grape-mcp-devtools

# 2. 配置环境
cp .env.example .env
# 编辑 .env 文件配置API密钥

# 3. 构建项目
cargo build --release

# 4. 运行动态MCP服务器
cargo run --bin dynamic_mcp_server
```

### 生产环境部署

#### Docker 部署
```dockerfile
# 使用项目提供的 Dockerfile
FROM rust:1.75 as builder
WORKDIR /app
COPY . .
RUN cargo build --release

FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*
COPY --from=builder /app/target/release/dynamic_mcp_server /usr/local/bin/
EXPOSE 8080
CMD ["dynamic_mcp_server"]
```

#### 系统服务部署
```bash
# 创建系统服务
sudo systemctl enable grape-mcp-devtools
sudo systemctl start grape-mcp-devtools
```

## 性能特性

### 性能优化策略

1. **内存管理**：
   - 使用 `mimalloc` 高性能内存分配器
   - 智能内存池管理
   - 零拷贝数据传输

2. **并发处理**：
   - Tokio 异步运行时
   - 并发文件处理
   - 流式数据处理

3. **缓存策略**：
   - 多层缓存架构
   - LRU 缓存淘汰
   - 预热机制

4. **网络优化**：
   - HTTP/2 支持
   - 连接池管理
   - 请求批处理

### 性能指标

- **响应时间**：平均 < 100ms
- **并发处理**：支持 1000+ 并发连接
- **内存使用**：基础内存 < 50MB
- **缓存命中率**：> 90%

## MCP 工具详细规格

### 工具参数Schema定义

每个MCP工具都有严格的参数Schema定义，确保类型安全和参数验证：

#### 文档搜索工具 (`search_docs`)
```json
{
  "type": "object",
  "required": ["query"],
  "properties": {
    "query": {
      "type": "string",
      "description": "搜索查询文本"
    },
    "language": {
      "type": "string", 
      "enum": ["rust", "go", "python", "javascript", "java", "dart"],
      "description": "编程语言过滤"
    },
    "limit": {
      "type": "integer",
      "minimum": 1,
      "maximum": 100,
      "default": 10,
      "description": "返回结果数量限制"
    },
    "similarity_threshold": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0,
      "default": 0.7,
      "description": "相似度阈值"
    }
  }
}
```

#### 版本检查工具 (`check_version`)
```json
{
  "type": "object", 
  "required": ["package"],
  "properties": {
    "package": {
      "type": "string",
      "description": "包名称"
    },
    "version": {
      "type": "string",
      "description": "当前版本号"
    },
    "language": {
      "type": "string",
      "enum": ["rust", "javascript", "python", "java"],
      "description": "编程语言"
    }
  }
}
```

#### 依赖分析工具 (`analyze_dependencies`)
```json
{
  "type": "object",
  "required": ["project_path"],
  "properties": {
    "project_path": {
      "type": "string",
      "description": "项目路径"
    },
    "include_dev_dependencies": {
      "type": "boolean",
      "default": false,
      "description": "是否包含开发依赖"
    },
    "check_vulnerabilities": {
      "type": "boolean", 
      "default": true,
      "description": "是否检查安全漏洞"
    }
  }
}
```

### 工具响应格式

#### 成功响应格式
```json
{
  "version": "2025-03-26",
  "id": "request-id",
  "result": {
    "status": "success",
    "data": {
      // 工具特定的返回数据
    },
    "metadata": {
      "execution_time_ms": 150,
      "cache_hit": true,
      "tool_version": "0.1.0"
    }
  }
}
```

#### 错误响应格式
```json
{
  "version": "2025-03-26", 
  "id": "request-id",
  "error": {
    "code": -33003,
    "message": "搜索执行失败",
    "data": {
      "error_type": "VectorizationError",
      "details": "向量化服务不可用",
      "suggestion": "请检查EMBEDDING_API_KEY配置"
    }
  }
}
```

### 环境检测和工具注册报告

#### 检测报告示例
```
🔍 CLI工具检测报告
=====================================
✅ cargo (1.75.0) - Rust包管理器
✅ npm (10.2.4) - Node.js包管理器  
✅ git (2.42.0) - 版本控制系统
❌ mvn - 未找到Maven
❌ gradle - 未找到Gradle
⚠️  clippy - 版本过低 (需要 >= 1.70.0)

📊 检测统计:
- 可用工具: 3 个
- 不可用工具: 2 个  
- 版本问题: 1 个

🎯 注册策略: OnlyAvailable
💡 将注册 8 个MCP工具 (3个特定 + 5个通用)
```

#### 注册报告示例
```
🚀 MCP工具注册报告
=====================================
✅ search_docs - 文档搜索工具
✅ check_version - 版本检查工具
✅ analyze_dependencies - 依赖分析工具
✅ rust_version_tool - Rust版本管理 (基于cargo)
✅ js_version_tool - Node.js版本管理 (基于npm)
✅ git_analysis_tool - Git分析工具 (基于git)
❌ java_version_tool - Maven不可用
⚠️  rust_lint_tool - Clippy版本不兼容

📊 注册统计:
- 成功注册: 6 个工具
- 注册失败: 1 个工具
- 跳过注册: 1 个工具

🎉 MCP服务器就绪，支持 6 个工具
```

## 扩展性设计

### 新语言支持

添加新编程语言支持的步骤：

1. **创建语言模块**：
   ```rust
   // src/tools/new_language_tool.rs
   pub struct NewLanguageTool {
       // 语言特定配置
   }
   
   impl MCPTool for NewLanguageTool {
       // 实现工具接口
   }
   ```

2. **实现文档生成器**：
   ```rust
   impl DocumentGenerator for NewLanguageGenerator {
       async fn generate_docs(&self, package: &str) -> Result<Vec<DocumentFragment>>;
   }
   ```

3. **注册工具**：
   ```rust
   server.register_tool(Box::new(NewLanguageTool::new())).await?;
   ```

### 新工具开发

开发新工具的标准流程：

1. **实现 MCPTool trait**
2. **定义工具注解**
3. **实现参数验证**
4. **添加错误处理**
5. **编写单元测试**
6. **更新文档**

## 测试策略

### 测试架构

```
tests/
├── integration/          # 集成测试
│   ├── mcp_protocol_tests.rs
│   ├── tool_integration_tests.rs
│   └── performance_tests.rs
├── unit/                # 单元测试
│   ├── vectorization_tests.rs
│   ├── storage_tests.rs
│   └── tool_tests.rs
└── fixtures/            # 测试数据
    ├── sample_docs/
    └── test_configs/
```

### 测试原则

- **真实环境测试**：所有测试基于真实环境，不使用 Mock
- **完整覆盖**：确保所有核心功能都有测试覆盖
- **性能测试**：包含性能基准测试
- **集成测试**：测试组件间的交互

## 监控和日志

### 日志系统

使用 `tracing` 框架提供结构化日志：

```rust
use tracing::{info, warn, error, debug};

// 不同级别的日志
debug!("详细调试信息");
info!("一般信息");
warn!("警告信息");
error!("错误信息");
```

### 监控指标

- **请求指标**：QPS、响应时间、错误率
- **资源指标**：CPU、内存、磁盘使用率
- **业务指标**：缓存命中率、向量化成功率
- **系统指标**：连接数、队列长度

## 安全考虑

### 安全特性

1. **API 密钥管理**：
   - 环境变量存储
   - 密钥轮换支持
   - 访问权限控制

2. **网络安全**：
   - HTTPS 强制
   - CORS 配置
   - 请求限流

3. **数据安全**：
   - 敏感数据加密
   - 访问日志记录
   - 数据备份策略

## 未来发展规划

### 短期目标（1-3个月）

- [ ] 完善 Python 和 JavaScript 支持
- [ ] 优化向量化性能
- [ ] 增加更多缓存策略
- [ ] 完善监控和告警

### 中期目标（3-6个月）

- [ ] 支持更多编程语言
- [ ] 实现分布式部署
- [ ] 添加 Web 管理界面
- [ ] 支持自定义向量模型

### 长期目标（6-12个月）

- [ ] 智能代码生成
- [ ] 多模态文档支持
- [ ] 企业级功能
- [ ] 云原生部署

## 贡献指南

### 开发环境设置

1. **安装 Rust**：
   ```bash
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   ```

2. **安装依赖**：
   ```bash
   # 安装 Qdrant
   docker run -p 6333:6333 qdrant/qdrant
   
   # 安装开发工具
   cargo install cargo-watch
   cargo install cargo-tarpaulin
   ```

3. **运行测试**：
   ```bash
   cargo test
   cargo test --features go-integration-tests
   ```

### 代码规范

- 遵循 Rust 官方代码风格
- 使用 `rustfmt` 格式化代码
- 使用 `clippy` 进行代码检查
- 编写完整的文档注释

### 提交流程

1. Fork 项目
2. 创建功能分支
3. 编写代码和测试
4. 提交 Pull Request
5. 代码审查和合并

## 许可证

本项目采用 MIT 许可证，详见 [LICENSE](../LICENSE) 文件。

## 联系方式

- **项目维护者**：Grape Team
- **问题反馈**：通过 GitHub Issues
- **技术讨论**：项目 Discussions 区域

---

*本文档最后更新时间：2024年12月* 