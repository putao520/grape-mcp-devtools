# åŠ¨æ€æ³¨å†Œæ¨¡å—å¼€å‘è®¡åˆ’

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

åŠ¨æ€æ³¨å†Œæ¨¡å—è´Ÿè´£å·¥å…·çš„æ³¨å†Œã€ç®¡ç†å’Œè°ƒç”¨è·¯ç”±ã€‚ä½œä¸ºç³»ç»Ÿçš„å·¥å…·ç®¡ç†ä¸­å¿ƒï¼Œå®ƒæä¾›äº†è¿è¡Œæ—¶å·¥å…·æ³¨å†Œã€å…ƒæ•°æ®ç®¡ç†å’Œè°ƒç”¨åˆ†å‘ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### æ¨¡å—å®šä½
- **èŒè´£**: MCPå·¥å…·æ³¨å†Œå’Œç®¡ç†
- **åŠŸèƒ½**: å·¥å…·å‘ç°ã€æ³¨å†Œã€è°ƒç”¨è·¯ç”±
- **é‡è¦æ€§**: ç³»ç»Ÿç®¡ç†æ ¸å¿ƒ
- **ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜ä¼˜å…ˆçº§

## ğŸ¯ å¼€å‘ç›®æ ‡

### ä¸»è¦ç›®æ ‡
1. **åŠ¨æ€å·¥å…·ç®¡ç†**: æ”¯æŒè¿è¡Œæ—¶å·¥å…·æ³¨å†Œå’Œæ³¨é”€
2. **æ™ºèƒ½è·¯ç”±**: é«˜æ•ˆçš„å·¥å…·è°ƒç”¨è·¯ç”±æœºåˆ¶
3. **å…ƒæ•°æ®ç®¡ç†**: å®Œæ•´çš„å·¥å…·ä¿¡æ¯å’Œèƒ½åŠ›æè¿°
4. **æ‰©å±•æ€§**: æ”¯æŒæ’ä»¶å¼å·¥å…·åŠ è½½

### å…·ä½“åŠŸèƒ½è¦æ±‚
- [ ] å·¥å…·æ³¨å†Œå’Œæ³¨é”€æœºåˆ¶
- [ ] å·¥å…·å…ƒæ•°æ®ç®¡ç†
- [ ] è°ƒç”¨è·¯ç”±å’Œåˆ†å‘
- [ ] å·¥å…·èƒ½åŠ›æŸ¥è¯¢
- [ ] æ’ä»¶å¼å·¥å…·åŠ è½½
- [ ] å·¥å…·çŠ¶æ€ç›‘æ§

## ğŸ“… å¼€å‘æ—¶é—´è¡¨

### Week 2-3: æ ¸å¿ƒå®ç°æœŸ
**æ—¶é—´**: ç¬¬2-3å‘¨ (10ä¸ªå·¥ä½œæ—¥)

#### Week 2: Day 3-5: åŸºç¡€æ¶æ„
- [ ] è®¾è®¡å·¥å…·æ³¨å†Œæ¥å£
- [ ] å®ç°å·¥å…·æ³¨å†Œä¸­å¿ƒ
- [ ] å»ºç«‹å…ƒæ•°æ®å­˜å‚¨ç»“æ„
- [ ] åˆ›å»ºåŸºç¡€æµ‹è¯•æ¡†æ¶

#### Week 3: Day 1-3: è·¯ç”±æœºåˆ¶
- [ ] å®ç°å·¥å…·è°ƒç”¨è·¯ç”±
- [ ] æ·»åŠ å‚æ•°éªŒè¯æœºåˆ¶
- [ ] å®ç°é”™è¯¯å¤„ç†å’Œå›é€€
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜

#### Week 3: Day 4-5: é«˜çº§åŠŸèƒ½
- [ ] æ’ä»¶å¼å·¥å…·åŠ è½½
- [ ] å·¥å…·çŠ¶æ€ç›‘æ§
- [ ] é…ç½®ç®¡ç†é›†æˆ
- [ ] å®Œæ•´æ€§æµ‹è¯•

## ğŸ”§ æŠ€æœ¯å®ç°è§„èŒƒ

### æ ¸å¿ƒæ•°æ®ç»“æ„

```rust
// å·¥å…·æ³¨å†Œä¸­å¿ƒ
pub struct ToolRegistry {
    tools: HashMap<String, Arc<dyn MCPTool>>,
    metadata: HashMap<String, ToolMetadata>,
    categories: HashMap<String, Vec<String>>,
    status: HashMap<String, ToolStatus>,
}

// å·¥å…·å…ƒæ•°æ®
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ToolMetadata {
    pub name: String,
    pub description: String,
    pub version: String,
    pub author: String,
    pub category: String,
    pub schema: serde_json::Value,
    pub requirements: Vec<String>,
    pub windows_compatible: bool,
}

// å·¥å…·çŠ¶æ€
#[derive(Debug, Clone)]
pub enum ToolStatus {
    Available,
    Loading,
    Error(String),
    Disabled,
}

// å·¥å…·è°ƒç”¨ç»“æœ
pub struct ToolCallResult {
    pub success: bool,
    pub data: serde_json::Value,
    pub metadata: Option<serde_json::Value>,
    pub execution_time: Duration,
}
```

### æ ¸å¿ƒæ¥å£å®šä¹‰

```rust
// å·¥å…·æ³¨å†Œæ¥å£
pub trait ToolRegistry: Send + Sync {
    async fn register_tool(&mut self, tool: Arc<dyn MCPTool>) -> Result<()>;
    async fn unregister_tool(&mut self, name: &str) -> Result<()>;
    fn get_tool(&self, name: &str) -> Option<Arc<dyn MCPTool>>;
    fn list_tools(&self) -> Vec<ToolInfo>;
    fn get_tool_metadata(&self, name: &str) -> Option<&ToolMetadata>;
}

// æ ‡å‡†MCPå·¥å…·æ¥å£
pub trait MCPTool: Send + Sync {
    fn name(&self) -> &str;
    fn description(&self) -> &str;
    fn version(&self) -> &str;
    fn schema(&self) -> serde_json::Value;
    async fn execute(&self, params: serde_json::Value) -> Result<ToolCallResult>;
    fn is_available(&self) -> bool;
    fn health_check(&self) -> Result<()>;
}
```

### ç¬¬ä¸‰æ–¹ä¾èµ–

```toml
[dependencies]
# åŸºç¡€ä¾èµ– (ç»§æ‰¿è‡ªMCPåè®®æ¨¡å—)
tokio = { version = "1.0", features = ["full"] }
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
anyhow = "1.0"

# æ³¨å†Œæ¨¡å—ç‰¹å®šä¾èµ–
dashmap = "5.4"           # å¹¶å‘å®‰å…¨çš„HashMap
libloading = "0.8"        # åŠ¨æ€åº“åŠ è½½
notify = "6.0"            # æ–‡ä»¶ç³»ç»Ÿç›‘æ§
lru = "0.12"              # LRUç¼“å­˜
```

### Windows å…¼å®¹æ€§
- æ”¯æŒ Windows DLL åŠ è½½
- å¤„ç† Windows è·¯å¾„å’Œæƒé™
- å…¼å®¹ PowerShell ç¯å¢ƒ
- æ”¯æŒ Windows æœåŠ¡æ¨¡å¼

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/dynamic_registry/
â”œâ”€â”€ mod.rs              # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ registry.rs         # å·¥å…·æ³¨å†Œä¸­å¿ƒå®ç°
â”œâ”€â”€ metadata.rs         # å…ƒæ•°æ®ç®¡ç†
â”œâ”€â”€ router.rs           # è°ƒç”¨è·¯ç”±å™¨
â”œâ”€â”€ loader.rs           # æ’ä»¶åŠ è½½å™¨
â”œâ”€â”€ monitor.rs          # çŠ¶æ€ç›‘æ§
â””â”€â”€ validation.rs       # å‚æ•°éªŒè¯

tests/dynamic_registry/
â”œâ”€â”€ registry_test.rs    # æ³¨å†ŒåŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ router_test.rs      # è·¯ç”±åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ loader_test.rs      # åŠ è½½å™¨æµ‹è¯•
â””â”€â”€ integration_test.rs # é›†æˆæµ‹è¯•
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æµ‹è¯•ç±»å‹

#### 1. å•å…ƒæµ‹è¯•
- [ ] å·¥å…·æ³¨å†Œå’Œæ³¨é”€åŠŸèƒ½
- [ ] å…ƒæ•°æ®ç®¡ç†åŠŸèƒ½
- [ ] è·¯ç”±åˆ†å‘é€»è¾‘
- [ ] å‚æ•°éªŒè¯æœºåˆ¶

#### 2. é›†æˆæµ‹è¯•
- [ ] å®Œæ•´çš„å·¥å…·ç”Ÿå‘½å‘¨æœŸ
- [ ] å¤šå·¥å…·å¹¶å‘è°ƒç”¨
- [ ] æ’ä»¶åŠ è½½å’Œå¸è½½
- [ ] é”™è¯¯æ¢å¤æœºåˆ¶

#### 3. æ€§èƒ½æµ‹è¯•
- [ ] å¤§é‡å·¥å…·æ³¨å†Œæ€§èƒ½
- [ ] é«˜å¹¶å‘è°ƒç”¨æ€§èƒ½
- [ ] å†…å­˜ä½¿ç”¨æ•ˆç‡
- [ ] è·¯ç”±æŸ¥æ‰¾é€Ÿåº¦

### æµ‹è¯•åœºæ™¯
- **æ­£å¸¸åœºæ™¯**: æ ‡å‡†å·¥å…·æ³¨å†Œå’Œè°ƒç”¨
- **å¼‚å¸¸åœºæ™¯**: å·¥å…·åŠ è½½å¤±è´¥ã€è°ƒç”¨é”™è¯¯
- **è¾¹ç•Œåœºæ™¯**: å¤§é‡å·¥å…·ã€é«˜å¹¶å‘è®¿é—®
- **æ¢å¤åœºæ™¯**: ç³»ç»Ÿé‡å¯åçŠ¶æ€æ¢å¤

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ç›®æ ‡æ€§èƒ½
- **å·¥å…·æ³¨å†Œ**: < 100ms
- **å·¥å…·æŸ¥æ‰¾**: < 1ms
- **è°ƒç”¨è·¯ç”±**: < 5ms
- **å¹¶å‘æ”¯æŒ**: 100+ å¹¶å‘è°ƒç”¨

### å†…å­˜æ•ˆç‡
- **åŸºç¡€å†…å­˜**: < 20MB
- **æ¯å·¥å…·å¼€é”€**: < 1MB
- **å…ƒæ•°æ®ç¼“å­˜**: < 10MB
- **æ— å†…å­˜æ³„æ¼**: é•¿æœŸè¿è¡Œç¨³å®š

## ğŸš¨ é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©
1. **åŠ¨æ€åŠ è½½å®‰å…¨æ€§**
   - é£é™©ç­‰çº§: é«˜
   - ç¼“è§£: å·¥å…·ç­¾åéªŒè¯ï¼Œæ²™ç›’æ‰§è¡Œ

2. **å†…å­˜ç®¡ç†å¤æ‚æ€§**
   - é£é™©ç­‰çº§: ä¸­
   - ç¼“è§£: æ™ºèƒ½æŒ‡é’ˆä½¿ç”¨ï¼Œå®šæœŸæ¸…ç†

3. **å¹¶å‘å®‰å…¨é—®é¢˜**
   - é£é™©ç­‰çº§: ä¸­
   - ç¼“è§£: ä½¿ç”¨å¹¶å‘å®‰å…¨æ•°æ®ç»“æ„

### é¡¹ç›®é£é™©
1. **å·¥å…·æ ‡å‡†åŒ–**
   - é£é™©ç­‰çº§: ä¸­
   - ç¼“è§£: ä¸¥æ ¼çš„æ¥å£è§„èŒƒï¼Œå®Œå–„æ–‡æ¡£

2. **æ€§èƒ½ç“¶é¢ˆ**
   - é£é™©ç­‰çº§: ä½
   - ç¼“è§£: æ€§èƒ½ç›‘æ§ï¼Œä¼˜åŒ–çƒ­ç‚¹

## ğŸ”§ å®ç°ç»†èŠ‚

### æ ¸å¿ƒå®ç°è¦ç‚¹

#### 1. å·¥å…·æ³¨å†Œä¸­å¿ƒ
```rust
impl ToolRegistry {
    pub async fn register_tool(&mut self, tool: Arc<dyn MCPTool>) -> Result<()> {
        let name = tool.name().to_string();
        
        // éªŒè¯å·¥å…·
        self.validate_tool(&tool)?;
        
        // æ³¨å†Œå·¥å…·
        self.tools.insert(name.clone(), tool.clone());
        
        // æ›´æ–°å…ƒæ•°æ®
        let metadata = self.extract_metadata(&tool)?;
        self.metadata.insert(name.clone(), metadata);
        
        // æ›´æ–°çŠ¶æ€
        self.status.insert(name, ToolStatus::Available);
        
        log::info!("å·¥å…·æ³¨å†ŒæˆåŠŸ: {}", name);
        Ok(())
    }
}
```

#### 2. æ™ºèƒ½è·¯ç”±å™¨
```rust
impl ToolRouter {
    pub async fn route_call(&self, call: ToolCall) -> Result<ToolCallResult> {
        // æŸ¥æ‰¾å·¥å…·
        let tool = self.registry.get_tool(&call.name)
            .ok_or_else(|| anyhow::anyhow!("å·¥å…·ä¸å­˜åœ¨: {}", call.name))?;
        
        // éªŒè¯å‚æ•°
        self.validate_params(&tool, &call.params)?;
        
        // æ‰§è¡Œè°ƒç”¨
        let start_time = Instant::now();
        let result = tool.execute(call.params).await?;
        let execution_time = start_time.elapsed();
        
        // è®°å½•ç»Ÿè®¡
        self.record_call_stats(&call.name, execution_time, result.success);
        
        Ok(result)
    }
}
```

#### 3. æ’ä»¶åŠ è½½å™¨
```rust
impl PluginLoader {
    pub async fn load_plugin(&mut self, path: &Path) -> Result<()> {
        // å®‰å…¨æ£€æŸ¥
        self.verify_plugin_signature(path)?;
        
        // åŠ è½½åŠ¨æ€åº“
        let lib = unsafe { libloading::Library::new(path)? };
        
        // è·å–å·¥å…·åˆ›å»ºå‡½æ•°
        let create_tool: Symbol<fn() -> Box<dyn MCPTool>> = 
            unsafe { lib.get(b"create_tool")? };
        
        // åˆ›å»ºå·¥å…·å®ä¾‹
        let tool = create_tool();
        
        // æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ
        self.registry.register_tool(Arc::from(tool)).await?;
        
        // ä¿å­˜åº“å¼•ç”¨
        self.loaded_libs.insert(tool.name().to_string(), lib);
        
        Ok(())
    }
}
```

## ğŸ“ˆ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] å·¥å…·æ³¨å†Œå’Œæ³¨é”€æ­£å¸¸å·¥ä½œ
- [ ] è°ƒç”¨è·¯ç”±å‡†ç¡®é«˜æ•ˆ
- [ ] å…ƒæ•°æ®ç®¡ç†å®Œæ•´
- [ ] æ’ä»¶åŠ è½½æœºåˆ¶ç¨³å®š

### æ€§èƒ½éªŒæ”¶
- [ ] æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
- [ ] é«˜å¹¶å‘æµ‹è¯•é€šè¿‡
- [ ] å†…å­˜ä½¿ç”¨æ§åˆ¶è‰¯å¥½
- [ ] æ— æ˜æ˜¾æ€§èƒ½ç“¶é¢ˆ

### å®‰å…¨éªŒæ”¶
- [ ] æ’ä»¶éªŒè¯æœºåˆ¶æœ‰æ•ˆ
- [ ] æ— ä»»æ„ä»£ç æ‰§è¡Œé£é™©
- [ ] é”™è¯¯éš”ç¦»æœºåˆ¶å®Œå–„
- [ ] æƒé™æ§åˆ¶é€‚å½“

## ğŸš€ éƒ¨ç½²å’Œé›†æˆ

### ä¸MCPåè®®æ¨¡å—é›†æˆ
```rust
// åœ¨MCPæœåŠ¡å™¨ä¸­é›†æˆæ³¨å†Œä¸­å¿ƒ
impl MCPServer {
    pub fn new() -> Self {
        let registry = Arc::new(RwLock::new(ToolRegistry::new()));
        
        Self {
            tool_registry: registry,
            session_state: Arc::new(RwLock::new(SessionState::default())),
            config: ServerConfig::default(),
        }
    }
    
    pub async fn register_builtin_tools(&self) -> Result<()> {
        let mut registry = self.tool_registry.write().await;
        
        // æ³¨å†Œå†…ç½®å·¥å…·
        registry.register_tool(Arc::new(VersionCheckTool::new())).await?;
        registry.register_tool(Arc::new(SearchDocsTool::new())).await?;
        
        Ok(())
    }
}
```

### é…ç½®ç®¡ç†
```toml
[tool_registry]
auto_discovery = true
plugin_directory = "plugins"
max_tools = 100
cache_size = 50
health_check_interval = 60

[security]
require_signatures = true
allowed_plugin_paths = ["./plugins", "C:/ProgramData/GrapeMCP/plugins"]
sandbox_mode = true
```

## ğŸ“‹ åç»­é›†æˆç‚¹

### ä¸ºåŠŸèƒ½æ¨¡å—æä¾›åŸºç¡€
1. **è¯­è¨€ç‰¹æ€§æ¨¡å—**: æ³¨å†Œå¤šè¯­è¨€å·¥å…·
2. **æ–‡æ¡£å¤„ç†æ¨¡å—**: æ³¨å†Œæ–‡æ¡£æœç´¢å·¥å…·
3. **CLIé›†æˆæ¨¡å—**: æ³¨å†Œå‘½ä»¤è¡Œå·¥å…·
4. **æ‰€æœ‰å…¶ä»–æ¨¡å—**: æä¾›ç»Ÿä¸€æ³¨å†Œæ¥å£

### æ‰©å±•æ€§è€ƒè™‘
- æ”¯æŒå·¥å…·ç‰ˆæœ¬ç®¡ç†
- æä¾›å·¥å…·ä¾èµ–è§£æ
- å®ç°å·¥å…·çƒ­æ›´æ–°
- æ”¯æŒåˆ†å¸ƒå¼å·¥å…·æ³¨å†Œ

---

**å¼€å‘è®¡åˆ’ç‰ˆæœ¬**: v1.0  
**è´Ÿè´£å›¢é˜Ÿ**: æ ¸å¿ƒæ¶æ„ç»„  
**é¢„è®¡å·¥æœŸ**: 1.5 å‘¨  
**ä¸Šæ¸¸ä¾èµ–**: MCPåè®®æ¨¡å—  
**ä¸‹æ¸¸ä¾èµ–**: æ‰€æœ‰åŠŸèƒ½æ¨¡å— 